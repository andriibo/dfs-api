image: atlassian/default-image:3

definitions:
  steps:
    - step: &deploy
        name: deploy_aws
        script:
          - pipe: atlassian/ssh-run:0.4.0
            variables:
              SSH_USER: $USER
              SERVER: $AWS_SERVER
              MODE: 'command'
              COMMAND:
                >-
                cd /var/www/${WORK_DIR:=dfs}/api &&
                git fetch --prune &&
                git checkout $BITBUCKET_BRANCH &&
                git pull &&
                docker-compose exec -T api composer install &&
                docker-compose exec -T api composer check-build &&
                docker-compose exec -T api php artisan down &&
                docker-compose exec -T api php artisan cache:clear &&
                docker-compose exec -T api php artisan config:cache &&
                docker-compose exec -T api php artisan route:cache &&
                docker-compose exec -T api php artisan l5-swagger:generate &&
                docker-compose exec -T api php artisan migrate &&
                docker-compose exec -T api php artisan up &&
                docker-compose exec -T api php artisan test
pipelines:
  custom:
    deploy-to-dev-aws:
      - step:
          <<: *deploy
          deployment: aws_development
          name: deploy to aws development
    deploy-to-stage-aws:
      - step:
          <<: *deploy
          deployment: aws_stage
          name: deploy to aws stage
  branches:
    develop:
      - step:
          <<: *deploy
          deployment: aws_development
          name: deploy to aws development
    master:
      - step:
          <<: *deploy
          deployment: aws_development
          name: deploy to aws development
    '{release/*}':
      - step:
          <<: *deploy
          deployment: aws_development
          name: deploy to aws development